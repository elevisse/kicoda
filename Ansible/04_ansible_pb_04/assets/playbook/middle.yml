---

# Ce playbook cree le user et le middle tomcat
- name: tomcat
  hosts: middle
  tasks:
  - name: installer jdk
    ansible.builtin.package:
      name:
      - openjdk-17-jdk
      - sudo
      state: latest
  - name: ajouter groupe tomcat
    ansible.builtin.group:
      name: tomcat
      state: present
  - name: ajouter user tomcat
    ansible.builtin.user:
      name: tomcat
      home: /opt/tomcat
      shell: /bin/false
      groups: tomcat
  - name: decompression sources tomcat
    ansible.builtin.unarchive:
      src: "https://downloads.apache.org/tomcat/tomcat-11/v11.0.9/bin/apache-tomcat-11.0.9.tar.gz"
      dest: "/opt/tomcat/"
      remote_src: true
      extra_opts: [--strip-components=1]
  - name: trouver les fichiers sh
    ansible.builtin.find:
      paths: /opt/tomcat/bin
      patterns: '*.sh'
    register: sh_files
  - name: Passer les sh executables
    ansible.builtin.file:
      path: "{{ item.path }}"
      mode: "0755"
    with_items: "{{ sh_files.files }}"
    notify: start tomcat with reboot
  - name: Creation lien symbolique
    ansible.builtin.file:
      src: /opt/tomcat/bin/startup.sh
      dest: /root/start-tomcat.sh
      owner: root
      group: root
      state: link
    notify: start tomcat with reboot
  handlers:
    - name: start tomcat with reboot
      ansible.builtin.command:
        cmd: "docker-compose -f /root/docker-compose.yml restart node03"
      delegate_to: localhost
